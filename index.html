<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analytics Platform</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
            --accent-user: #4f46e5;
            --accent-bot: #e2e8f0;
            --accent-success: #dcfce7;
            --accent-success-text: #166534;
        }

        .dark {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --bg-tertiary: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-user: #4338ca;
            --accent-bot: #1e293b;
            --accent-success: #14532d;
            --accent-success-text: #dcfce7;
        }

        body { 
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .sidebar { background-color: var(--bg-secondary); border-color: var(--border-color); }
        .sidebar-icon.active { background-color: #4338ca; color: white; }
        
        .chat-bubble { border: 1px solid var(--border-color); }
        .chat-bubble-bot { background-color: var(--accent-bot); color: var(--text-primary); }
        .chat-bubble-user { background-color: var(--accent-user); color: white; }
        .chat-bubble-success { background-color: var(--accent-success); color: var(--accent-success-text); }
        
        .header, .input-area { background-color: var(--bg-secondary); border-color: var(--border-color); }
        .input-form { background-color: var(--bg-tertiary); }

        .metric-card { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); }
        .chart-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); }

        .action-button { transition: all 0.2s ease-in-out; }
        .action-button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .dark .action-button:hover:not(:disabled) { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }

        @keyframes spin { to { transform: rotate(360deg); } }
        .loader { border: 2px solid rgba(150,150,150,0.2); border-left-color: var(--text-primary); animation: spin 1s linear infinite; }
        
        .data-table-wrapper { max-height: calc(100vh - 10rem); overflow: auto; }
        .data-table { border-collapse: collapse; width: 100%; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; white-space: nowrap; border-bottom: 1px solid var(--border-color); }
        .data-table th { background-color: var(--bg-tertiary); position: sticky; top: 0; z-index: 10; }
        
        .history-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .history-item:hover {
            background-color: var(--bg-tertiary);
        }
        .dark .history-item:hover {
            background-color: #1a2333;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">
    <aside class="sidebar w-20 p-4 flex flex-col items-center justify-between border-r">
        <div>
            <div class="w-10 h-10 mb-10 rounded-lg bg-gradient-to-tr from-cyan-500 to-blue-500 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            </div>
            <nav id="sidebar-nav" class="space-y-4">
                <button data-view="dashboard" class="sidebar-icon p-3 rounded-lg hover:bg-slate-700 action-button disabled:cursor-not-allowed disabled:opacity-50" disabled title="Dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg></button>
                <button data-view="data" class="sidebar-icon p-3 rounded-lg hover:bg-slate-700 action-button disabled:cursor-not-allowed disabled:opacity-50" disabled title="Data View"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                <button data-view="chat" class="sidebar-icon p-3 rounded-lg hover:bg-slate-700 action-button active" title="Chat"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg></button>
                <!-- New History Button -->
                <button data-view="history" class="sidebar-icon p-3 rounded-lg hover:bg-slate-700 action-button" title="Chat History"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2zM9 16h6m-1-4h-4m2-4V6m0-3a9 9 0 110 18A9 9 0 0112 3z" /></svg></button>
            </nav>
        </div>
        <button id="upload-button" class="action-button p-3 rounded-lg bg-indigo-600 hover:bg-indigo-500" title="Upload New File"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></button>
    </aside>

    <main class="flex-1 flex flex-col h-screen">
        <header class="header p-4 border-b flex items-center justify-between">
            <h2 id="view-title" class="text-xl font-semibold">Chat & Analysis</h2>
            <button id="theme-toggle" class="action-button p-2 rounded-lg hover:bg-slate-700">
                <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </header>
        <div id="view-container" class="flex-1 flex flex-col overflow-y-auto">
            </div>
    </main>
    <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, .xls" />

</body>
</html>

<script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, limit, addDoc, getDocs, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


    // Global Firebase instances and user ID - these will be populated after auth
    let db = null;
    let auth = null;
    let currentUserId = null;

    // --- DOM References ---
    const viewContainer = document.getElementById('view-container');
    const sidebarNav = document.getElementById('sidebar-nav');
    const fileInput = document.getElementById('file-input');
    const uploadButton = document.getElementById('upload-button');
    const themeToggle = document.getElementById('theme-toggle');

    // --- App State ---
    let uploadedData = null;
    let isLoading = false;
    let chartCounter = 0;
    const chartSpecs = {}; 
    let currentChatSessionId = null;
    let currentChatMessages = []; // Stores messages for the current session in memory

    // --- App Views ---
    const views = {
        chat: {
            title: 'Chat & Analysis',
            content: `<div id="chat-container" class="flex-1 p-6 space-y-8 overflow-y-auto"></div>
                      <div class="input-area p-4 border-t">
                          <form id="chat-form" class="flex items-center input-form rounded-lg p-2 gap-2 shadow-lg max-w-4xl mx-auto">
                              <input type="text" id="message-input" placeholder="Ask a question..." class="flex-1 bg-transparent focus:outline-none px-3" />
                              <button type="submit" id="send-button" disabled class="bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md action-button">Send</button>
                          </form>
                      </div>`
        },
        dashboard: {
            title: 'Dashboard',
            content: `<div id="dashboard-content" class="p-6 overflow-y-auto">
                                <div id="metrics-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8"></div>
                                <div id="charts-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                            </div>`
        },
        data: {
            title: 'Data Table',
            content: `<div id="data-table-container" class="p-6 data-table-wrapper"></div>`
        },
        history: {
            title: 'Chat History',
            content: `<div id="history-list" class="p-6 space-y-4 overflow-y-auto">
                        <p class="text-secondary-text">Loading chat history...</p>
                      </div>`
        }
    };
    
    // --- View Management ---
    function switchView(viewName) {
        if (!views[viewName]) return;
        viewContainer.innerHTML = views[viewName].content;
        document.getElementById('view-title').textContent = views[viewName].title;

        // Re-attach event listeners for dynamic content
        if (viewName === 'chat') {
            document.getElementById('chat-form').addEventListener('submit', handleChatSubmit);
            document.getElementById('message-input').addEventListener('input', (e) => {
                document.getElementById('send-button').disabled = !e.target.value.trim();
            });
            // Re-render current messages if returning to chat view
            renderChatMessages();
        } else if (viewName === 'data' && uploadedData) {
            renderDataTable();
        } else if (viewName === 'history') {
            loadChatHistory();
        }
        
        sidebarNav.querySelectorAll('.sidebar-icon').forEach(icon => {
            icon.classList.toggle('active', icon.dataset.view === viewName);
        });
    }

    // --- Initial State ---
    function renderInitialState() {
        switchView('chat');
        // Initial conversational message only if no chat history is loaded
        if (!currentChatSessionId && currentChatMessages.length === 0) {
            appendBotMessage({ type: 'default', content: 'Hello! To get started, please upload a CSV or Excel file using the upload button on the bottom left. Once uploaded, I can help you analyze your data and answer questions.'}, false); // Don't save initial message to history
        }

        // Simulate initial data load and display in data view
        const predefinedData = [
          {
            "product_name": "TP-Link USB WiFi Adapter for PC(TL-WN725N), N150 Wireless Network Adapter for Desktop - Nano Size WiFi Dongle Compatible with Windows 11/10/7/8/8.1/XP/ Mac OS 10.9-10.15 Linux Kernel 2.6.18-4.4.3",
            "rating_count": 179691
          },
          {
            "product_name": "boAt Deuce USB 300 2 in 1 Type-C & Micro USB Stress Resistant, Tangle-Free, Sturdy Cable with 3A Fast Charging & 480mbps Data Transmission, 10000+ Bends Lifespan and Extended 1.5m Length(Martian Red)",
            "rating_count": 94363
          },
          {
            "product_name": "Ambrane Unbreakable 60W / 3A Fast Charging 1.5m Braided Type C Cable for Smartphones, Tablets, Laptops & other Type C devices, PD Technology, 480Mbps Data Sync, Quick Charge 3.0 (RCT15A, Black)",
            "rating_count": 43994
          },
          {
            "product_name": "Ambrane Unbreakable 60W / 3A Fast Charging 1.5m Braided Micro USB Cable for Smartphones, Tablets, Laptops & Other Micro USB Devices, 480Mbps Data Sync, Quick Charge 3.0 (RCM15, Black)",
            "rating_count": 43994
          },
          {
            "product_name": "MI Usb Type-C Cable Smartphone (Black)",
            "rating_count": 30411
          },
          {
            "product_name": "pTron Solero TB301 3A Type-C Data and Fast Charging Cable, Made in India, 480Mbps Data Sync, Strong and Durable 1.5-Meter Nylon Braided USB Cable for Type-C Devices for Charging Adapter (Black)",
            "rating_count": 24871
          },
          {
            "product_name": "Wayona Nylon Braided USB to Lightning Fast Charging and Data Sync Cable Compatible for iPhone 13, 12,11, X, 8, 7, 6, 5, iPad Air, Pro, Mini (3 FT Pack of 1, Grey)",
            "rating_count": 24269
          },
          {
            "product_name": "Portronics Konnect L 1.2M Fast Charging 3A 8 Pin USB Cable with Charge & Sync Function for iPhone, iPad (Grey)",
            "rating_count": 16905
          },
          {
            "product_name": "boAt Micro USB 55 Tangle-free, Sturdy Micro USB Cable with 3A Fast Charging & 480mbps Data Transmission (Black)",
            "rating_count": 15188
          },
          {
            "product_name": "Sounce Fast Phone Charging Cable & Data Sync USB Cable Compatible for iPhone 13, 12,11, X, 8, 7, 6, 5, iPad Air, Pro, Mini & iOS Devices",
            "rating_count": 7928
          }
        ];
        uploadedData = predefinedData; // Set the global uploadedData
        
        // Enable dashboard and data view buttons
        sidebarNav.querySelectorAll('button').forEach(btn => btn.disabled = false);

        // Switch to data view and render the table
        switchView('data');
        setTimeout(() => { // Small delay to ensure DOM is ready
            renderDataTable();
        }, 50);

        // Update metrics grid for the pre-loaded data
        const metricsGrid = document.getElementById('metrics-grid');
        if(metricsGrid) {
            const headers = Object.keys(uploadedData[0]);
            metricsGrid.innerHTML = `
                <div class="metric-card p-4 rounded-lg shadow-sm">
                    <h3 class="text-sm text-secondary mb-1">Total Rows</h3>
                    <p class="text-2xl font-bold">${uploadedData.length}</p>
                </div>
                <div class="metric-card p-4 rounded-lg shadow-sm">
                    <h3 class="text-sm text-secondary mb-1">Total Columns</h3>
                    <p class="text-2xl font-bold">${headers.length}</p>
                </div>
                <div class="metric-card p-4 rounded-lg shadow-sm">
                    <h3 class="text-sm text-secondary mb-1">Headers</h3>
                    <p class="text-md font-bold text-secondary break-words">${headers.join(', ')}</p>
                </div>
            `; 
        }
    }

    // --- UI & Messaging ---
    function setLoading(state) {
        isLoading = state;
        document.querySelectorAll('button, input').forEach(el => el.disabled = state);
        if (state) appendBotMessage({ type: 'loader' });
        else {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.parentElement.remove();
            
            // Re-enable buttons, but keep dashboard/data disabled if no data is loaded
            document.querySelectorAll('button').forEach(el => {
                if (uploadedData === null && (el.dataset.view === 'dashboard' || el.dataset.view === 'data')) {
                    el.disabled = true;
                } else {
                    el.disabled = false;
                }
            });
            if (document.getElementById('message-input') && !document.getElementById('message-input').value.trim()) {
                document.getElementById('send-button').disabled = true;
            }
        }
    }

    async function appendUserMessage(message, saveToHistory = true) {
        const chatContainer = document.getElementById('chat-container');
        if(!chatContainer) return;

        const messageObject = {
            role: 'user',
            content: message,
            timestamp: Date.now()
        };
        currentChatMessages.push(messageObject); // Add to in-memory history

        const messageHtml = `<div class="flex items-start gap-4 justify-end"><div class="chat-bubble chat-bubble-user rounded-lg p-4 max-w-2xl"><p>${message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p></div><div class="w-9 h-9 rounded-full flex-shrink-0 bg-slate-600 flex items-center justify-center font-bold text-white">U</div></div>`;
        chatContainer.insertAdjacentHTML('beforeend', messageHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        if (saveToHistory && db && currentUserId && currentChatSessionId) {
            try {
                // Use __app_id for the collection path as required
                await addDoc(collection(db, `artifacts/${__app_id}/users/${currentUserId}/chatSessions/${currentChatSessionId}/messages`), messageObject);
            } catch (error) {
                console.error("Error saving user message to Firestore:", error);
            }
        }
    }

    async function appendBotMessage(response, saveToHistory = true) {
        const chatContainer = document.getElementById('chat-container');
        if(!chatContainer) return;
        const botIconHtml = `<div class="w-9 h-9 rounded-full flex-shrink-0 bg-gradient-to-tr from-cyan-500 to-blue-500 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div>`;
        let contentHtml;
        let messageToSave = {};

        if(response.type === 'success') {
            contentHtml = `<div class="chat-bubble chat-bubble-success rounded-lg p-4 max-w-2xl flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p>${response.content}</p></div>`;
            messageToSave = { type: 'success', content: response.content };
        } else if (response.type === 'loader') {
            contentHtml = `<div id="loading-indicator" class="flex items-start gap-4">${botIconHtml}<div class="chat-bubble chat-bubble-bot rounded-lg p-4 max-w-2xl"><div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-6 w-6"></div><span class="ml-2">Thinking...</span></div></div>`;
            saveToHistory = false; // Don't save loader messages
        } else if (response.type === 'chart') {
            const chartId = `chart-${chartCounter++}`;
            chartSpecs[chartId] = response.content; 
            contentHtml = `<div class="chat-bubble chat-bubble-bot rounded-lg p-4 max-w-2xl w-full">
                <div class="bg-slate-900 p-4 rounded-lg"><canvas id="${chartId}"></canvas></div>
                <button data-chart-id="${chartId}" class="add-to-dashboard-btn mt-4 w-full bg-teal-600 hover:bg-teal-500 text-white font-semibold py-2 px-4 rounded-md action-button">Add to Dashboard</button>
            </div>`;
            setTimeout(() => renderChart(chartId, response.content), 0);
            messageToSave = { type: 'chart', content: JSON.stringify(response.content) }; // Save chart spec as string
        } else if (response.type === 'table') {
            const tableData = response.content;
            if (tableData && tableData.length > 0) {
                const headers = Object.keys(tableData[0]);
                let tableHtml = `
                    <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    ${headers.map(header => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">${header}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                                ${tableData.map(row => `
                                    <tr>
                                        ${headers.map(header => `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${row[header] !== undefined ? row[header] : ''}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                contentHtml = `<div class="chat-bubble chat-bubble-bot rounded-lg p-4 max-w-2xl w-full">${tableHtml}</div>`;
                messageToSave = { type: 'table', content: JSON.stringify(response.content) }; // Save table data as string
            } else {
                contentHtml = `<div class="chat-bubble chat-bubble-bot rounded-lg p-4 max-w-2xl"><p>No data to display in table format.</p></div>`;
                messageToSave = { type: 'default', content: "No data to display in table format." };
            }
        } else {
            const bubbleClass = response.type === 'error' ? 'bg-red-900/50 border-red-700 text-red-300' : 'chat-bubble-bot';
            contentHtml = `<div class="chat-bubble ${bubbleClass} rounded-lg p-4 max-w-2xl"><p class="whitespace-pre-wrap">${response.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p></div>`;
            messageToSave = { type: response.type || 'default', content: response.content };
        }

        if (saveToHistory && db && currentUserId && currentChatSessionId) {
            const messageObject = {
                role: 'bot',
                ...messageToSave,
                timestamp: Date.now()
            };
            currentChatMessages.push(messageObject); // Add to in-memory history

            try {
                // Use __app_id for the collection path as required
                await addDoc(collection(db, `artifacts/${__app_id}/users/${currentUserId}/chatSessions/${currentChatSessionId}/messages`), messageObject);
            } catch (error) {
                console.error("Error saving bot message to Firestore:", error);
            }
        } else if (!saveToHistory) {
             // For loader messages or initial messages not to be saved, just render them
             chatContainer.insertAdjacentHTML('beforeend', `<div class="flex items-start gap-4">${botIconHtml}${contentHtml}</div>`);
             chatContainer.scrollTop = chatContainer.scrollHeight;
        } else {
            // For cases where saveToHistory is true but Firestore isn't ready
            const messageObject = {
                role: 'bot',
                ...messageToSave,
                timestamp: Date.now()
            };
            currentChatMessages.push(messageObject); // Still add to in-memory for current session display
            chatContainer.insertAdjacentHTML('beforeend', `<div class="flex items-start gap-4">${botIconHtml}${contentHtml}</div>`);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }
    
    // Renders messages from currentChatMessages array to the DOM
    function renderChatMessages() {
        const chatContainer = document.getElementById('chat-container');
        if (!chatContainer) return;
        chatContainer.innerHTML = ''; // Clear existing messages
        currentChatMessages.forEach(msg => {
            if (msg.role === 'user') {
                const messageHtml = `<div class="flex items-start gap-4 justify-end"><div class="chat-bubble chat-bubble-user rounded-lg p-4 max-w-2xl"><p>${msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p></div><div class="w-9 h-9 rounded-full flex-shrink-0 bg-slate-600 flex items-center justify-center font-bold text-white">U</div></div>`;
                chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            } else if (msg.role === 'bot') {
                let contentHtml;
                const botIconHtml = `<div class="w-9 h-9 rounded-full flex-shrink-0 bg-gradient-to-tr from-cyan-500 to-blue-500 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div>`;

                if (msg.type === 'chart') {
                    const chartSpec = JSON.parse(msg.content);
                    const chartId = `chart-${chartCounter++}`; // Generate a new ID for the rendered chart
                    chartSpecs[chartId] = chartSpec; // Store the spec
                    contentHtml = `<div class="chat-bubble chat-bubble-bot rounded-lg p-4 max-w-2xl w-full">
                        <div class="bg-slate-900 p-4 rounded-lg"><canvas id="${chartId}"></canvas></div>
                        <button data-chart-id="${chartId}" class="add-to-dashboard-btn mt-4 w-full bg-teal-600 hover:bg-teal-500 text-white font-semibold py-2 px-4 rounded-md action-button">Add to Dashboard</button>
                    </div>`;
                    chatContainer.insertAdjacentHTML('beforeend', `<div class="flex items-start gap-4">${botIconHtml}${contentHtml}</div>`);
                    setTimeout(() => renderChart(chartId, chartSpec), 0);
                } else if (msg.type === 'table') {
                    const tableData = JSON.parse(msg.content);
                    if (tableData && tableData.length > 0) {
                        const headers = Object.keys(tableData[0]);
                        let tableHtml = `
                            <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-800">
                                        <tr>
                                            ${headers.map(header => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">${header}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                                        ${tableData.map(row => `
                                            <tr>
                                                ${headers.map(header => `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${row[header] !== undefined ? row[header] : ''}</td>`).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        contentHtml = `<div class="chat-bubble chat-bubble-bot rounded-lg p-4 max-w-2xl w-full">${tableHtml}</div>`;
                    } else {
                        contentHtml = `<div class="chat-bubble chat-bubble-bot rounded-lg p-4 max-w-2xl"><p>No data to display in table format.</p></div>`;
                    }
                    chatContainer.insertAdjacentHTML('beforeend', `<div class="flex items-start gap-4">${botIconHtml}${contentHtml}</div>`);
                }
                else {
                    const bubbleClass = msg.type === 'error' ? 'bg-red-900/50 border-red-700 text-red-300' : 'chat-bubble-bot';
                    contentHtml = `<div class="chat-bubble ${bubbleClass} rounded-lg p-4 max-w-2xl"><p class="whitespace-pre-wrap">${msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p></div>`;
                    chatContainer.insertAdjacentHTML('beforeend', `<div class="flex items-start gap-4">${botIconHtml}${contentHtml}</div>`);
                }
            }
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // --- Chart & Dashboard Rendering ---
    function renderChart(canvasId, chartSpec) {
        const ctx = document.getElementById(canvasId)?.getContext('2d');
        if(!ctx) return;
        new Chart(ctx, chartSpec);
    }
    
    function addChartToDashboard(canvasId) {
        const chartSpec = chartSpecs[canvasId]; 
        if (!chartSpec) {
            console.error('Chart specification not found for ID:', canvasId);
            return;
        }
        
        switchView('dashboard');
        
        setTimeout(() => {
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card rounded-lg p-4';
            const newCanvas = document.createElement('canvas');
            newCanvas.id = `dashboard-${canvasId}`;
            
            chartCard.appendChild(newCanvas);
            document.getElementById('charts-grid').appendChild(chartCard);
            
            new Chart(newCanvas.getContext('2d'), JSON.parse(JSON.stringify(chartSpec)));
        }, 100);
    }

    function renderDataTable() {
        const dataTableContainer = document.getElementById('data-table-container');
        if (!dataTableContainer || !uploadedData || uploadedData.length === 0) return;

        const headers = Object.keys(uploadedData[0]);
        let tableHtml = `
            <table class="data-table">
                <thead>
                    <tr>
                        ${headers.map(header => `<th>${header}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${uploadedData.map(row => `
                        <tr>${headers.map(header => `<td>${row[header] !== undefined ? row[header] : ''}</td>`).join('')}</tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        dataTableContainer.innerHTML = tableHtml;
    }

    // --- Chat History Functions ---
    async function startNewChatSession() {
        if (!db || !currentUserId) {
            console.warn("Firestore not ready to start new chat session.");
            return;
        }
        try {
            // Create a new chat session document
            // Use __app_id for the collection path as required
            const newSessionRef = await addDoc(collection(db, `artifacts/${__app_id}/users/${currentUserId}/chatSessions`), {
                createdAt: Date.now(),
                initialMessage: "New chat session", // Or extract a summary from the first user message/file upload
                lastUpdated: Date.now(),
                fileInfo: uploadedData ? {
                    name: fileInput.files[0] ? fileInput.files[0].name : 'N/A',
                    rows: uploadedData.length,
                    columns: Object.keys(uploadedData[0]).length
                } : null
            });
            currentChatSessionId = newSessionRef.id;
            currentChatMessages = []; // Clear in-memory messages for new session
            console.log("New chat session started:", currentChatSessionId);
            // After starting a new session, ensure chat view is clear and ready
            switchView('chat');
            document.getElementById('chat-container').innerHTML = '';
        } catch (error) {
            console.error("Error starting new chat session:", error);
        }
    }

    async function loadChatHistory() {
        const historyListContainer = document.getElementById('history-list');
        if (!historyListContainer) return;
        historyListContainer.innerHTML = '<p class="text-secondary-text">Loading chat history...</p>';

        if (!db || !currentUserId) {
            historyListContainer.innerHTML = '<p class="text-red-500">Firestore not available. Please ensure authentication is successful.</p>';
            return;
        }

        try {
            // Use __app_id for the collection path as required
            const q = query(collection(db, `artifacts/${__app_id}/users/${currentUserId}/chatSessions`), orderBy("lastUpdated", "desc"));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                historyListContainer.innerHTML = '<p class="text-secondary-text">No chat history found. Start a new conversation!</p>';
                return;
            }

            historyListContainer.innerHTML = ''; // Clear loading message

            querySnapshot.forEach((doc) => {
                const session = doc.data();
                const sessionId = doc.id;
                const date = new Date(session.lastUpdated).toLocaleString();
                const sessionTitle = session.fileInfo ? `${session.fileInfo.name} (${session.fileInfo.rows} rows)` : session.initialMessage || `Chat Session ${date}`;

                const historyItem = document.createElement('div');
                historyItem.className = 'history-item bg-secondary-bg hover:bg-tertiary-bg rounded-lg cursor-pointer p-3';
                historyItem.dataset.sessionId = sessionId;
                historyItem.innerHTML = `
                    <h4 class="font-semibold text-primary-text">${sessionTitle}</h4>
                    <p class="text-sm text-secondary-text">Last active: ${date}</p>
                `;
                historyItem.addEventListener('click', () => loadChatSession(sessionId, sessionTitle));
                historyListContainer.appendChild(historyItem);
            });
        } catch (error) {
            console.error("Error loading chat sessions:", error);
            historyListContainer.innerHTML = `<p class="text-red-500">Error loading history: ${error.message}</p>`;
        }
    }

    async function loadChatSession(sessionId, sessionTitle) {
        if (!db || !currentUserId) {
            console.warn("Firestore not ready to load chat session.");
            return;
        }

        switchView('chat'); // Switch to chat view to display messages
        document.getElementById('chat-container').innerHTML = ''; // Clear current display
        appendBotMessage({ type: 'default', content: `Loading chat session: "${sessionTitle || sessionId}"...`}, false); // Don't save this loading message

        try {
            // Use __app_id for the collection path as required
            const q = query(collection(db, `artifacts/${__app_id}/users/${currentUserId}/chatSessions/${sessionId}/messages`), orderBy("timestamp"));
            const querySnapshot = await getDocs(q);

            currentChatMessages = []; // Clear in-memory cache for new session
            querySnapshot.forEach(doc => {
                const msg = doc.data();
                currentChatMessages.push(msg);
            });
            currentChatSessionId = sessionId; // Set active session

            renderChatMessages(); // Render all loaded messages
            appendBotMessage({ type: 'success', content: `Successfully loaded chat session.`}, false); // Don't save this confirmation message
        } catch (error) {
            console.error("Error loading messages for session:", sessionId, error);
            appendBotMessage({ type: 'error', content: `Failed to load chat session: ${error.message}` });
            currentChatMessages = []; // Clear on error
        }
    }

    // --- Core Logic ---
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        switchView('chat'); // Keep this to show upload message in chat
        setTimeout(async () => { // Made async to await startNewChatSession
            appendUserMessage(`Uploaded "${file.name}".`);
            setLoading(true);

            if (db && currentUserId) {
                await startNewChatSession(); // Start a new session on file upload
            } else {
                appendBotMessage({ type: 'error', content: 'Firebase not initialized. Chat history will not be saved.'});
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    let parsedData;
                    if (file.name.endsWith('.csv')) {
                        parsedData = Papa.parse(data, { header: true, skipEmptyLines: true }).data;
                    } else {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        parsedData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    }
                    if(!parsedData || parsedData.length === 0) throw new Error("File is empty or could not be parsed.");
                    
                    uploadedData = parsedData;
                    
                    
                    // Enable dashboard and data view buttons now that data is available
                    sidebarNav.querySelectorAll('button').forEach(btn => btn.disabled = false);

                    // Update the chat session with file info if it's already started
                    if (db && currentUserId && currentChatSessionId) {
                        // Use __app_id for the collection path as required
                        setDoc(doc(db, `artifacts/${__app_id}/users/${currentUserId}/chatSessions`, currentChatSessionId), {
                            fileInfo: {
                                name: file.name,
                                rows: uploadedData.length,
                                columns: Object.keys(uploadedData[0]).length
                            },
                            lastUpdated: Date.now()
                        }, { merge: true });
                    }

                    // Add success message for file upload and prompt for next action
                    appendBotMessage({ type: 'success', content: `Great! The file "${file.name}" has been successfully uploaded and processed. It contains ${uploadedData.length} rows and ${Object.keys(uploadedData[0]).length} columns. How can I help you analyze this data today? Feel free to ask questions like "Show me a bar chart of X vs Y" or "What is the average of Z column?".`});

                    // Switch to dashboard view *before* trying to populate its content
                    switchView('dashboard'); 
                    // Add a slight delay to ensure the DOM is updated after switchView
                    setTimeout(() => {
                        const headers = Object.keys(uploadedData[0]);
                        const metricsGrid = document.getElementById('metrics-grid');
                        if(metricsGrid) {
                            metricsGrid.innerHTML = `
                                <div class="metric-card p-4 rounded-lg shadow-sm">
                                    <h3 class="text-sm text-secondary mb-1">Total Rows</h3>
                                    <p class="text-2xl font-bold">${uploadedData.length}</p>
                                </div>
                                <div class="metric-card p-4 rounded-lg shadow-sm">
                                    <h3 class="text-sm text-secondary mb-1">Total Columns</h3>
                                    <p class="text-2xl font-bold">${headers.length}</p>
                                </div>
                                <div class="metric-card p-4 rounded-lg shadow-sm">
                                    <h3 class="text-sm text-secondary mb-1">Headers</h3>
                                    <p class="text-md font-bold text-secondary break-words">${headers.join(', ')}</p>
                                </div>
                            `; 
                        }
                        
                        const chartsGrid = document.getElementById('charts-grid');
                        if(chartsGrid) chartsGrid.innerHTML = ''; // Clear existing charts

                    }, 50); // Small delay to allow DOM update
                } catch (error) {
                    appendBotMessage({ type: 'error', content: `Failed to parse file: ${error.message}`});
                } finally {
                    setLoading(false);
                }
            };
            reader.onerror = () => { setLoading(false); appendBotMessage({ type: 'error', content: 'Failed to read the file.'}); };
            if (file.name.endsWith('.csv')) reader.readAsText(file);
            else reader.readAsBinaryString(file);
        }, 100);
    }
    
    async function handleChatSubmit(e) {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        if (!message || isLoading) return;
        appendUserMessage(message);
        messageInput.value = '';
        document.getElementById('send-button').disabled = true;
        getAiResponse(message);
    }
    
    async function getAiResponse(message) {
        setLoading(true);
        let prompt;
        if (uploadedData) {
            const headers = Object.keys(uploadedData[0]).join(', ');
            // Send a sample of the data, not the whole thing, to save token cost and improve speed
            const dataSample = Papa.unparse(uploadedData.slice(0, Math.min(uploadedData.length, 10))); // Send first 10 rows
            prompt = `You are an expert data analyst AI. A user has uploaded a dataset. The dataset has the following columns: ${headers}. Here is a small sample of the data (first 10 rows):\n${dataSample}\n\nBased on this dataset, the user's request is: "${message}".\n\nIf the request is for a numerical summary (e.g., sum, average, count, min, max, unique values), provide the answer directly in a plain text response.
            
If the request is for tabular data (e.g., "show me the top 5 products by rating count", "list all products"), provide a JSON object with 'type': 'table' and 'content' as an array of objects. Each object in the 'content' array should represent a row. The keys of the objects will be the table headers.
Example Table JSON response:
{
  "type": "table",
  "content": [
    { "Product Name": "Product A", "Rating Count": 1000 },
    { "Product Name": "Product B", "Rating Count": 900 }
  ]
}

If the request is for a chart, provide a JSON object formatted for Chart.js. The JSON should have a 'type' property (e.g., 'bar', 'line', 'pie', 'doughnut', 'scatter'), and a 'data' object. If appropriate, include an 'options' object for customization (e.g., title, axis labels, responsiveness). Ensure numerical data is correctly parsed for charts. For category-based charts, use the provided data to derive appropriate labels and data points.

If the request is general or cannot be answered with the provided data, a table, or a chart, provide a concise, helpful plain text response.
Respond ONLY with the requested information (plain text summary, Chart.js JSON, Table JSON, or general text response). Do not include any conversational filler outside of what's strictly necessary for the answer.`;
        } else {
            prompt = `You are a helpful AI assistant. A user has asked a question: "${message}". There is no data currently uploaded. If the user asks for data analysis or charts, please inform them that they need to upload a file first. Otherwise, answer the question generally.`;
        }
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" }};
        const apiKey = "XXXXXXXXXXXXXXXXXX"; // Replace with your actual Gemini API Key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
            const result = await response.json();
            const aiContentString = result.candidates[0].content.parts[0].text;
            
            try {
                const aiResponse = JSON.parse(aiContentString);
                // Check if it's a Chart.js spec or a simple text response
                if (aiResponse.type && (aiResponse.type === 'chart' || aiResponse.type === 'table')) { 
                    appendBotMessage({ type: aiResponse.type, content: aiResponse.content });
                } else {
                    // If it's a JSON but not a chart/table, or a plain object
                    appendBotMessage({ type: 'default', content: JSON.stringify(aiResponse, null, 2) });
                }
            } catch (jsonError) {
                // If it's not valid JSON, treat as a plain text response
                appendBotMessage({ type: 'default', content: aiContentString });
            }
        } catch (error) {
            appendBotMessage({ type: 'error', content: `Sorry, I encountered an error: ${error.message}. Please check your API key and network connection.` });
        } finally {
            setLoading(false);
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Firebase here, once globally.
        // Check for __firebase_config and __initial_auth_token provided by the Canvas environment
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Use the Canvas-provided config if available, otherwise use your hardcoded one
        const firebaseConfigToUse = canvasFirebaseConfig || {
            // !!! IMPORTANT: Replace these placeholder values with your actual Firebase project configuration !!!
            apiKey: "YOUR_FIREBASE_API_KEY", 
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID",
            measurementId: "YOUR_FIREBASE_MEASUREMENT_ID"
        };

        try {
            let app;
            if (!getApps().length) { // Check if no Firebase app has been initialized yet
                app = initializeApp(firebaseConfigToUse);
            } else {
                app = getApp(); // Get the already initialized app
            }
            
            db = getFirestore(app); // Assign to global db
            auth = getAuth(app); // Assign to global auth
            console.log("Firebase initialized.");

            // Authenticate user
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // Assign to global currentUserId
                    console.log("Firebase authenticated. User ID:", currentUserId);
                    renderInitialState(); // Call after successful authentication
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase authentication error:", error);
                        appendBotMessage({ type: 'error', content: `Authentication failed: ${error.message}` });
                        renderInitialState(); // Still render UI even if auth fails
                    }
                }
            });
        } catch (error) {
            console.error("Error during Firebase initialization or authentication process:", error);
            appendBotMessage({ type: 'error', content: `Firebase setup failed: ${error.message}` });
            renderInitialState(); // Render app even without Firebase features
        }

        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFileUpload);
        uploadButton.addEventListener('click', () => fileInput.click());
        sidebarNav.addEventListener('click', (e) => {
            const button = e.target.closest('.sidebar-icon');
            if (button && !button.disabled) switchView(button.dataset.view);
        });
        viewContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.add-to-dashboard-btn');
            if(button) {
                addChartToDashboard(button.dataset.chartId);
                button.textContent = 'Added to Dashboard';
                button.disabled = true;
            }
        });

        // Theme Toggle Logic
        themeToggle.addEventListener('click', () => {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            document.getElementById('theme-icon-sun').classList.toggle('hidden', !isDark);
            document.getElementById('theme-icon-moon').classList.toggle('hidden', isDark);
        });

        // Initial check for theme (sets to moon if dark is default)
        const isDarkDefault = document.documentElement.classList.contains('dark');
        document.getElementById('theme-icon-sun').classList.toggle('hidden', !isDarkDefault);
        document.getElementById('theme-icon-moon').classList.toggle('hidden', isDarkDefault);
    });
</script>
